name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.0'
        channel: 'stable'

    - name: è·å–Flutterä¾èµ–
      run: flutter pub get

    - name: æ„å»ºWindowsåº”ç”¨
      run: |
        flutter config --enable-windows-desktop
        flutter build windows --release

    - name: æ„å»ºAndroid APK
      run: flutter build apk --split-per-abi --release

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir release-files

        # å¤åˆ¶Windows exeæ–‡ä»¶
        Copy-Item "build\windows\x64\runner\Release\*" -Destination "release-files\" -Recurse

        # é‡å‘½åWindowsåº”ç”¨æ–‡ä»¶å¤¹
        Rename-Item "release-files" "letter_drop_animation_windows"

        # å‹ç¼©Windowsåº”ç”¨
        Compress-Archive -Path "letter_drop_animation_windows" -DestinationPath "letter_drop_animation_windows.zip"

        # å¤åˆ¶Android APKæ–‡ä»¶ï¼ˆsplit-per-abiç”Ÿæˆå¤šä¸ªAPKï¼‰
        Copy-Item "build\app\outputs\flutter-apk\app-arm64-v8a-release.apk" -Destination "letter_drop_animation-arm64-v8a.apk"
        Copy-Item "build\app\outputs\flutter-apk\app-armeabi-v7a-release.apk" -Destination "letter_drop_animation-armeabi-v7a.apk"
        Copy-Item "build\app\outputs\flutter-apk\app-x86_64-release.apk" -Destination "letter_drop_animation-x86_64.apk"
      shell: powershell

    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT

        # ä»pubspec.yamlè·å–åº”ç”¨åç§°å’Œæè¿°
        $pubspec = Get-Content pubspec.yaml
        $name = ($pubspec | Select-String "name: (.+)").Matches[0].Groups[1].Value
        $description = ($pubspec | Select-String "description: (.+)").Matches[0].Groups[1].Value
        echo "APP_NAME=$name" >> $env:GITHUB_OUTPUT
        echo "APP_DESCRIPTION=$description" >> $env:GITHUB_OUTPUT
      shell: powershell

    - name: åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ æ–‡ä»¶
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: ${{ steps.get_version.outputs.APP_NAME }} ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸ‰ ${{ steps.get_version.outputs.APP_NAME }} ${{ steps.get_version.outputs.VERSION }}

          ### ğŸ“± ä¸‹è½½
          - **Windows**: ä¸‹è½½ `letter_drop_animation_windows.zip` å¹¶è§£å‹è¿è¡Œ
          - **Android ARM64**: ä¸‹è½½ `letter_drop_animation-arm64-v8a.apk`ï¼ˆæ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç°ä»£Androidè®¾å¤‡ï¼‰
          - **Android ARM32**: ä¸‹è½½ `letter_drop_animation-armeabi-v7a.apk`ï¼ˆé€‚ç”¨äºè¾ƒè€çš„Androidè®¾å¤‡ï¼‰
          - **Android x86_64**: ä¸‹è½½ `letter_drop_animation-x86_64.apk`ï¼ˆé€‚ç”¨äºx86æ¶æ„è®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨ï¼‰

          ### ğŸ“ æ›´æ–°å†…å®¹
          - æ–°ç‰ˆæœ¬å‘å¸ƒ
          - æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤

          ### ğŸ’» ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Android**: Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬

          ### ğŸ”§ æŠ€æœ¯æ ˆ
          - Flutter 3.32.0
          - Dart SDK ^3.7.0
          - Flameæ¸¸æˆå¼•æ“
          - Forge2Dç‰©ç†å¼•æ“

          ---

          ${{ steps.get_version.outputs.APP_DESCRIPTION }}
        files: |
          letter_drop_animation_windows.zip
          letter_drop_animation-arm64-v8a.apk
          letter_drop_animation-armeabi-v7a.apk
          letter_drop_animation-x86_64.apk
        draft: false
        prerelease: false
